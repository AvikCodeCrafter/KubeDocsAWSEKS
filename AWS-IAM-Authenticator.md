# AWS IAM Authenticator for Kubernetes AWS EKS

## Overview

The **AWS IAM Authenticator** is a command-line tool that allows Kubernetes clusters to authenticate users using AWS IAM credentials. It is widely used with **Amazon EKS (Elastic Kubernetes Service)** but can also work with self-managed Kubernetes clusters.

## How AWS IAM Authenticator Works

AWS IAM Authenticator uses **AWS IAM identities (users or roles)** for authentication in Kubernetes instead of native Kubernetes credentials.

### Authentication Flow
1. The user executes a `kubectl` command.
2. Kubernetes delegates authentication to `aws-iam-authenticator`.
3. `aws-iam-authenticator` fetches AWS IAM credentials (using AWS CLI, SDKs, or EC2 instance metadata).
4. AWS IAM signs the request with AWS STS (Secure Token Service).
5. Kubernetes verifies the IAM identity using the configured authentication webhook.
6. Kubernetes **RBAC (Role-Based Access Control)** determines the userâ€™s permissions.

---

## Installation and Setup

### Installing AWS IAM Authenticator

#### Linux/macOS
```sh
curl -o aws-iam-authenticator \n    https://s3.us-west-2.amazonaws.com/amazon-eks/1.21.2/2021-07-05/bin/linux/amd64/aws-iam-authenticator
chmod +x ./aws-iam-authenticator
sudo mv ./aws-iam-authenticator /usr/local/bin/
```

#### Mac (Homebrew)
```sh
brew install aws-iam-authenticator
```

#### Windows (Chocolatey)
```sh
choco install aws-iam-authenticator
```

#### Verify Installation
```sh
aws-iam-authenticator version
```

---

## Integrating AWS IAM Authenticator with Kubernetes

### Step 1: Update kubeconfig to use IAM Authenticator
```sh
aws eks update-kubeconfig --name <cluster-name> --region <region>
```
- This modifies `~/.kube/config` to use `aws-iam-authenticator` for authentication.

### Step 2: Configure IAM Role Mappings in Kubernetes
Amazon EKS uses a **ConfigMap** called `aws-auth` to map IAM identities to Kubernetes roles.

#### View Current aws-auth ConfigMap
```sh
kubectl get configmap -n kube-system aws-auth -o yaml
```

#### Example: Mapping an IAM Role to Kubernetes RBAC
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: aws-auth
  namespace: kube-system
data:
  mapRoles: |
    - rolearn: arn:aws:iam::123456789012:role/KubernetesAdmin
      username: admin
      groups:
        - system:masters
  mapUsers: |
    - userarn: arn:aws:iam::123456789012:user/kube-user
      username: kube-user
      groups:
        - system:masters
```
- `rolearn`: AWS IAM Role ARN to be authenticated.
- `username`: The Kubernetes username assigned.
- `groups`: The Kubernetes RBAC group for authorization.

---

## Authentication Mechanism

When using `kubectl`, Kubernetes calls the webhook authentication service configured in the API server.

### Example Authentication Token Request
```sh
aws eks get-token --cluster-name <cluster-name>
```
This generates a temporary authentication token, which is used to access the Kubernetes API.

### Example kubeconfig Entry
```yaml
users:
- name: eks-user
  user:
    exec:
      apiVersion: client.authentication.k8s.io/v1beta1
      command: aws-iam-authenticator
      args:
        - token
        - -i
        - my-cluster
```
- **`aws-iam-authenticator token -i my-cluster`** retrieves a token signed with AWS IAM credentials.
- The Kubernetes API server verifies the token via a webhook.

---

## Common Errors and Troubleshooting

### 1. "Unauthorized" error when running `kubectl`
- Check if your IAM role/user is mapped in the `aws-auth` ConfigMap.
- Verify your IAM role has the correct EKS permissions.

### 2. "could not get token: AccessDeniedException"
- Ensure your AWS credentials have the `eks:DescribeCluster` permission.

### 3. IAM Authenticator Binary Not Found
- Ensure `aws-iam-authenticator` is installed and accessible in `$PATH`:
  ```sh
  which aws-iam-authenticator
  ```

### 4. Token Expired Issue
- AWS tokens generated by `aws-iam-authenticator` are valid for **15 minutes**.
- If you receive an **expired token** error, regenerate the token using:
  ```sh
  aws eks get-token --cluster-name <cluster-name>
  ```

---

## Best Practices
- **Use IAM Roles Instead of IAM Users**: Roles provide better security and can be assumed dynamically.
- **Leverage Kubernetes RBAC**: Restrict permissions based on least privilege access.
- **Rotate IAM Credentials Regularly**: Avoid hardcoding AWS credentials.
- **Enable MFA for AWS IAM Users**: Adds an extra layer of security.

---

## Additional Resources
- ðŸ“– [AWS EKS Documentation](https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html)
- ðŸ”— [GitHub Repository](https://github.com/kubernetes-sigs/aws-iam-authenticator)
- ðŸŽ¥ [AWS EKS Authentication Guide](https://aws.amazon.com/blogs/containers/authenticating-to-kubernetes-with-aws-iam-authenticator-for-kubernetes/)

Let me know if you need help with any specific setup! ðŸš€
